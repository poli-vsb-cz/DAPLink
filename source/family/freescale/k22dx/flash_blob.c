/**
 * @file    flash_blob.c
 * @brief   Flash algorithm for the k22dx
 *
 * DAPLink Interface Firmware
 * Copyright (c) 2009-2019, ARM Limited, All Rights Reserved
 * SPDX-License-Identifier: Apache-2.0
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include "flash_blob.h"

static const uint32_t K20D50M_FLM[] = {
    0xE00ABE00, 
    0xb084b580, 0x60f8af00, 0x607a60b9, 0xf24c4b21, 0x81da5220, 0xf64d4b1f, 0x81da1228, 0x881b4b1d,
    0x4a1cb29b, 0x0301f023, 0x8013b29b, 0x785b4b1a, 0xf003b2db, 0x2b400360, 0x2301bf0c, 0xb2da2300,
    0xf8594b16, 0x701a3003, 0xf8594b14, 0x781b3003, 0xd00f2b00, 0x785b4b10, 0x4a0fb2db, 0x0360f023,
    0x7053b2db, 0x4b0cbf00, 0xb2db785b, 0x0360f003, 0xd1f82b00, 0xf8594b0a, 0x46183003, 0xf8aaf000,
    0x2b004603, 0x2301bf14, 0xb2db2300, 0x37104618, 0xbd8046bd, 0x40052000, 0x4007e000, 0x0000003c,
    0x00000040, 0xb083b480, 0x6078af00, 0xf8594b10, 0x781b3003, 0xd0122b00, 0x785b4b0c, 0xf023b2db,
    0xb2db0360, 0xf0434a09, 0xb2db0340, 0xbf007053, 0x785b4b06, 0xf003b2db, 0x2b400360, 0x2300d1f8,
    0x370c4618, 0xbc8046bd, 0xbf004770, 0x4007e000, 0x0000003c, 0xb082b580, 0x490caf00, 0xf8594b0c,
    0x46183003, 0xf8c4f000, 0x687b6078, 0xd1072b00, 0x4b072100, 0x3003f859, 0xf0004618, 0x6078f9b5,
    0x4618687b, 0x46bd3708, 0xbf00bd80, 0x6b65666b, 0x00000040, 0xb084b580, 0x6078af00, 0xf8594b10,
    0x68da3003, 0x68794b0d, 0xf859480d, 0xf0000000, 0x60f8f8c5, 0x2b0068fb, 0x4b09d10b, 0x3003f859,
    0x230068da, 0x48066879, 0x0000f859, 0xf9aaf000, 0x68fb60f8, 0x37104618, 0xbd8046bd, 0x6b65666b,
    0x00000040, 0xb08ab580, 0x60f8af04, 0x607a60b9, 0x687a68bb, 0x480e68f9, 0x0000f859, 0xf90af000,
    0x697b6178, 0xd10e2b00, 0x93022300, 0x93012300, 0x93002301, 0x68ba687b, 0x480568f9, 0x0000f859,
    0xf9f8f000, 0x697b6178, 0x37184618, 0xbd8046bd, 0x00000040, 0xb085b480, 0x6078af00, 0x2b00687b,
    0x2304d101, 0x4b1ee036, 0x5380f503, 0x0e1b6cdb, 0xf003b2db, 0x72fb030f, 0x2b0f7afb, 0xf44fd103,
    0x60fb3300, 0x7afae007, 0xf8594b16, 0xf8333003, 0x029b3012, 0x687b60fb, 0x601a2200, 0x68fa687b,
    0x687b605a, 0x609a2201, 0xf44f687b, 0x60da6200, 0x2200687b, 0x687b615a, 0x619a2200, 0x2200687b,
    0x687b611a, 0x52a0f04f, 0x687b621a, 0x5280f44f, 0x2300625a, 0x37144618, 0xbc8046bd, 0xbf004770,
    0x40047000, 0x00000038, 0xb083b480, 0x6078af00, 0x687b6039, 0xd1012b00, 0xe0032304, 0x683a687b,
    0x2300611a, 0x370c4618, 0xbc8046bd, 0x00004770, 0xb084b580, 0x6078af00, 0x687b6039, 0xd1012b00,
    0xe0142304, 0xf06f4b0c, 0x601a423b, 0xf0006838, 0x60f8fa8d, 0x2b0068fb, 0x68fbd001, 0x6878e007,
    0xf9dcf000, 0x687860f8, 0xfa0af000, 0x461868fb, 0x46bd3710, 0xbf00bd80, 0x40020004, 0xb090b580,
    0x60f8af00, 0x607a60b9, 0xf107603b, 0x461a0310, 0x68f868b9, 0xfa37f000, 0x687a6a3b, 0x68f868b9,
    0xfa00f000, 0x6bbb63b8, 0xd0012b00, 0xe04b6bbb, 0x60bb693b, 0x637b697b, 0x687b68ba, 0x3b014413,
    0x6bfb63fb, 0xfbb36b7a, 0x6b79f2f2, 0xf202fb01, 0x2b001a9b, 0x6bfad02e, 0xfbb26b7b, 0x3301f3f3,
    0x6b3b633b, 0xfb026b7a, 0x3b01f303, 0xe02163fb, 0xf02368bb, 0x4a16437f, 0x6310f043, 0x68386013,
    0xfa34f000, 0x6bbb63b8, 0xd0012b00, 0xe01b6bbb, 0xf00068f8, 0x63b8f983, 0x691b68fb, 0xd0022b00,
    0x691b68fb, 0x6bbb4798, 0xd1082b00, 0x6b7b68ba, 0x60bb4413, 0x6bfb68ba, 0xd9d9429a, 0xbf00e000,
    0xf00068f8, 0x6bbbf99d, 0x37404618, 0xbd8046bd, 0x40020004, 0xb08eb580, 0x60f8af00, 0x607a60b9,
    0x687b603b, 0xd1012b00, 0xe0572304, 0x0314f107, 0x68b9461a, 0xf00068f8, 0x6a3bf9c6, 0x68b9683a,
    0xf00068f8, 0x6378f98f, 0x2b006b7b, 0x6b7bd001, 0x697be044, 0xe03860bb, 0x1d1a687b, 0x4a21607a,
    0x681b3204, 0x6a3b6013, 0xd1072b04, 0xf02368bb, 0x4a1c437f, 0x63c0f043, 0xe0106013, 0x2b086a3b,
    0x687bd10d, 0x607a1d1a, 0x32084a16, 0x6013681b, 0xf02368bb, 0x4a13437f, 0x63e0f043, 0x68f86013,
    0xf91cf000, 0x68fb6378, 0x2b00691b, 0x68fbd002, 0x4798691b, 0x2b006b7b, 0x6a3bd10b, 0x441368ba,
    0x6a3b60bb, 0x1ad3683a, 0x683b603b, 0xd1c32b00, 0xbf00e000, 0xf00068f8, 0x6b7bf933, 0x37384618,
    0xbd8046bd, 0x40020004, 0xb082b580, 0x6078af00, 0x70fb460b, 0x2b00687b, 0x2304d101, 0x78fbe009,
    0x4906041a, 0x43134b06, 0x6878600b, 0xf8e6f000, 0x46184603, 0x46bd3708, 0xbf00bd80, 0x40020004,
    0x4000ffff, 0xb092b580, 0x60f8af00, 0x607a60b9, 0xf10770fb, 0x461a0310, 0x68f868b9, 0xf943f000,
    0x687a6a7b, 0x68f868b9, 0xf90cf000, 0x6bbb63b8, 0xd0012b00, 0xe0566bbb, 0x0310f107, 0x68b9461a,
    0xf00068f8, 0x693bf930, 0x69bb60bb, 0x68bb637b, 0x461a425b, 0x425b6b7b, 0x425b4013, 0x6c7a647b,
    0x429a68bb, 0x6c7ad103, 0x44136b7b, 0x687b647b, 0xe034643b, 0x68bb6c7a, 0x63fb1ad3, 0x6c3b6bfa,
    0xd901429a, 0x63fb6c3b, 0x6bfa6a7b, 0xf3f3fbb2, 0x68bb633b, 0x437ff023, 0xf0434a15, 0x60137380,
    0x041a6b3b, 0x021b78fb, 0x4b11431a, 0xf0423304, 0x601a02ff, 0xf00068f8, 0x63b8f881, 0x2b006bbb,
    0x6bbbd001, 0x6c3ae00f, 0x1ad36bfb, 0x68ba643b, 0x44136bfb, 0x6c7a60bb, 0x44136b7b, 0x6c3b647b,
    0xd1c72b00, 0x46182300, 0x46bd3748, 0xbf00bd80, 0x40020004, 0xb08eb580, 0x60f8af00, 0x607a60b9,
    0x683b603b, 0xd1012b00, 0xe0512304, 0x0314f107, 0x68b9461a, 0xf00068f8, 0x6b3bf8c6, 0x68b9687a,
    0xf00068f8, 0x6378f88f, 0x2b006b7b, 0x6b7bd001, 0x697be03e, 0xe03560bb, 0xf02368bb, 0x4a1e437f,
    0x7300f043, 0xf8976013, 0x061a3040, 0x33044b1a, 0x427ff062, 0x4b18601a, 0x683a3308, 0x601a6812,
    0xf00068f8, 0x6378f82b, 0x2b006b7b, 0x6c7bd00c, 0xd0022b00, 0x68ba6c7b, 0x6cbb601a, 0xd0152b00,
    0x22006cbb, 0xe011601a, 0x687a6b3b, 0x607b1ad3, 0xf0236b3b, 0x683a0303, 0x603b4413, 0x68ba6b3b,
    0x60bb4413, 0x2b00687b, 0xe000d1c6, 0x6b7bbf00, 0x37384618, 0xbd8046bd, 0x40020004, 0xb085b480,
    0x6078af00, 0x22704b15, 0x4b14701a, 0x701a2280, 0x4b12bf00, 0xb2db781b, 0x2b00b25b, 0x4b0fdaf9,
    0x73fb781b, 0xf0037bfb, 0x2b000320, 0x2367d001, 0x7bfbe00e, 0x0310f003, 0xd0012b00, 0xe0072368,
    0xf0037bfb, 0x2b000301, 0x2369d001, 0x2300e000, 0x37144618, 0xbc8046bd, 0xbf004770, 0x40020000,
    0xb083b480, 0x6078af00, 0x685b4b05, 0xf4434a04, 0x60530370, 0x370cbf00, 0xbc8046bd, 0xbf004770,
    0x4001f000, 0xb085b480, 0x60f8af00, 0x607a60b9, 0x68fb603b, 0xd1012b00, 0xe01f2304, 0x1e5a683b,
    0x401368bb, 0xd1052b00, 0x1e5a683b, 0x4013687b, 0xd0012b00, 0xe0112365, 0x681b68fb, 0x429a68ba,
    0x68bad309, 0x441a687b, 0x681968fb, 0x685b68fb, 0x429a440b, 0x2366d901, 0x2300e000, 0x37144618,
    0xbc8046bd, 0xb5804770, 0xaf00b084, 0x60b960f8, 0x68fb607a, 0xd1012b00, 0xe0232304, 0x21002220,
    0xf0006878, 0x687bf835, 0x601a68ba, 0x68da68fb, 0x605a687b, 0x685a68fb, 0x689b68fb, 0xf2f3fbb2,
    0x609a687b, 0x2204687b, 0x687b60da, 0x611a2208, 0x2208687b, 0x687b615a, 0x619a2204, 0x2204687b,
    0x230061da, 0x37104618, 0xbd8046bd, 0xb083b480, 0x6078af00, 0x4a05687b, 0xd0014293, 0xe000236b,
    0x46182300, 0x46bd370c, 0x4770bc80, 0x6b65666b, 0xb5300783, 0x1e54d048, 0xd03f2a00, 0x4603b2ca,
    0x3c01e001, 0xf803d33a, 0x079d2b01, 0x2c03d1f9, 0xb2cdd92d, 0x2505ea45, 0xea452c0f, 0xd9364505,
    0x0210f1a4, 0x0c0ff022, 0x0e20f103, 0xea4f44e6, 0xf1031c12, 0xe9420210, 0xe9425504, 0x32105502,
    0xd1f84572, 0x0201f10c, 0x0f0cf014, 0x1202eb03, 0x0c0ff004, 0xf1acd013, 0xf0230304, 0x33040303,
    0xf8424413, 0x42935b04, 0xf00cd1fb, 0xb12c0403, 0x441cb2ca, 0x2b01f803, 0xd1fb429c, 0x4664bd30,
    0x2c004613, 0xe7f9d1f4, 0x46144603, 0x461ae7bf, 0xe7e046a4, 0x40020004, 0x40020010, 0x00100008,
    0x00200018, 0x00400030, 0x00800060, 0x010000c0, 0x02000180, 0x04000300, 0x00000600, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
    0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0000089c, 0x000008f4,
    0x000008c0, 0x00000000, 0x00000000, 0x00000000
};

/**
* List of start and size for each size of flash sector
* The size will apply to all sectors between the listed address and the next address
* in the list.
* The last pair in the list will have sectors starting at that address and ending
* at address start + size.
*/
static const sector_info_t sectors_info[] = {
    {0, 1024},
 };

static const program_target_t flash = {
    0x20000005, // Init
    0x200000a9, // UnInit
    0x200000f9, // EraseChip
    0x20000139, // EraseSector
    0x20000189, // ProgramPage
    0x0, // Verify

    // BKPT : start of blob + 1
    // RSB  : blob start + header + rw data offset
    // RSP  : stack pointer
    {
        0x20000001,
        0x200008c4,
        0x20000c00
    },

    0x20000000 + 0x00000A00,  // mem buffer location
    0x20000000,               // location to write prog_blob in target RAM
    sizeof(K20D50M_FLM),   // prog_blob size
    K20D50M_FLM,           // address of prog_blob
    0x00000400       // ram_to_flash_bytes_to_be_written
};
